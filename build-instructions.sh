#!/bin/bash

# ğŸ—ï¸ Instructions Build System
# æŒ‡ç¤ºæ›¸ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ  - ãƒ™ãƒ¼ã‚¹æŒ‡ç¤ºæ›¸ã¨å°‚é–€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’çµ±åˆ

set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«åœæ­¢

# è‰²ä»˜ããƒ­ã‚°é–¢æ•°
log_info() {
    echo -e "\033[1;32m[BUILD]\033[0m $1"
}

log_success() {
    echo -e "\033[1;34m[SUCCESS]\033[0m $1"
}

log_error() {
    echo -e "\033[1;31m[ERROR]\033[0m $1"
}

log_warn() {
    echo -e "\033[1;33m[WARN]\033[0m $1"
}

# ä½¿ç”¨æ–¹æ³•è¡¨ç¤º
usage() {
    echo "ğŸ—ï¸ Instructions Build System"
    echo ""
    echo "Usage: $0 [options]"
    echo ""
    echo "Options:"
    echo "  --clean      ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    echo "  --watch      ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›£è¦–ã—ã¦è‡ªå‹•ãƒ“ãƒ«ãƒ‰"
    echo "  --help       ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
    echo ""
    echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :"
    echo "  instructions-src/     ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«"
    echo "  â”œâ”€â”€ base/            ãƒ™ãƒ¼ã‚¹æŒ‡ç¤ºæ›¸"
    echo "  â””â”€â”€ templates/       å°‚é–€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ"
    echo ""
    echo "  instructions-built/   ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«"
    echo "  â”œâ”€â”€ teams/           ãƒãƒ¼ãƒ åˆ¥æŒ‡ç¤ºæ›¸"
    echo "  â””â”€â”€ roles/           å½¹å‰²åˆ¥æŒ‡ç¤ºæ›¸"
    echo ""
    echo "Example:"
    echo "  $0                   # å…¨æŒ‡ç¤ºæ›¸ã‚’ãƒ“ãƒ«ãƒ‰"
    echo "  $0 --clean           # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    echo "  $0 --watch           # ç›£è¦–ãƒ¢ãƒ¼ãƒ‰"
    exit 1
}

# å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®ç¢ºèª
check_dependencies() {
    if ! command -v jq &> /dev/null; then
        log_error "jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚"
        echo "Mac: brew install jq"
        echo "Linux: sudo apt-get install jq"
        exit 1
    fi
}

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean_build() {
    log_info "ğŸ§¹ ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
    rm -rf instructions-built
    mkdir -p instructions-built/{teams,roles}
    log_success "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
}

# æŒ‡ç¤ºæ›¸çµ±åˆé–¢æ•°
merge_instructions() {
    local base_file="$1"
    local specialty_file="$2"
    local output_file="$3"
    local role_name="$4"
    local manager_name="$5"
    local worker_name="$6"
    
    # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    mkdir -p "$(dirname "$output_file")"
    
    if [ -f "$base_file" ] && [ -f "$specialty_file" ]; then
        log_info "çµ±åˆä¸­: $(basename "$base_file") + $(basename "$specialty_file") â†’ $(basename "$output_file")"
        
        # ãƒ™ãƒ¼ã‚¹æŒ‡ç¤ºæ›¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å½¹è·åã‚’ç½®æ›
        sed "s/\[ãƒªãƒ¼ãƒ€ãƒ¼å½¹è·\]/$role_name/g; s/\[ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å½¹è·\]/$manager_name/g; s/\[ãƒ¯ãƒ¼ã‚«ãƒ¼å½¹è·\]/$worker_name/g; s/\[ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å\]/boss1/g" "$base_file" > "$output_file"
        
        # å°‚é–€æŒ‡ç¤ºæ›¸ã®å†…å®¹ã‚’è¿½åŠ ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã¯é™¤ãï¼‰
        echo "" >> "$output_file"
        echo "---" >> "$output_file"
        echo "" >> "$output_file"
        tail -n +2 "$specialty_file" >> "$output_file"
        
    elif [ -f "$specialty_file" ]; then
        log_warn "ãƒ™ãƒ¼ã‚¹æŒ‡ç¤ºæ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $base_file"
        log_info "å°‚é–€æŒ‡ç¤ºæ›¸ã®ã¿ã‚³ãƒ”ãƒ¼: $(basename "$specialty_file") â†’ $(basename "$output_file")"
        cp "$specialty_file" "$output_file"
        
    elif [ -f "$base_file" ]; then
        log_warn "å°‚é–€æŒ‡ç¤ºæ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $specialty_file"
        log_info "ãƒ™ãƒ¼ã‚¹æŒ‡ç¤ºæ›¸ã®ã¿ã‚³ãƒ”ãƒ¼: $(basename "$base_file") â†’ $(basename "$output_file")"
        sed "s/\[ãƒªãƒ¼ãƒ€ãƒ¼å½¹è·\]/$role_name/g; s/\[ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å½¹è·\]/$manager_name/g; s/\[ãƒ¯ãƒ¼ã‚«ãƒ¼å½¹è·\]/$worker_name/g; s/\[ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å\]/boss1/g" "$base_file" > "$output_file"
        
    else
        log_error "æŒ‡ç¤ºæ›¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $base_file, $specialty_file"
        return 1
    fi
    
    # ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ 
    add_build_header "$output_file" "$base_file" "$specialty_file"
}

# ãƒ“ãƒ«ãƒ‰æƒ…å ±ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ 
add_build_header() {
    local output_file="$1"
    local base_file="$2"
    local specialty_file="$3"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ—¢å­˜å†…å®¹ã‚’ä¿å­˜
    local temp_file=$(mktemp)
    cat "$output_file" > "$temp_file"
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãã§æ›¸ãç›´ã—
    cat > "$output_file" << EOF
<!-- 
ğŸ—ï¸ AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
Generated by: build-instructions.sh
Build time: $timestamp
Base file: $base_file
Specialty file: $specialty_file
-->

EOF
    
    cat "$temp_file" >> "$output_file"
    rm "$temp_file"
}

# å½¹å‰²åˆ¥æŒ‡ç¤ºæ›¸ã®ãƒ“ãƒ«ãƒ‰
build_role_instructions() {
    log_info "ğŸ“ å½¹å‰²åˆ¥æŒ‡ç¤ºæ›¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
    
    local roles_file="./team-roles.json"
    if [ ! -f "$roles_file" ]; then
        log_error "team-roles.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        return 1
    fi
    
    # å„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‡¦ç†
    local templates=$(jq -r '.templates | keys[]' "$roles_file")
    
    for template in $templates; do
        log_info "ğŸ¯ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†ä¸­: $template"
        
        local team_name=$(jq -r ".templates.\"$template\".name" "$roles_file")
        local leader_role=$(jq -r ".templates.\"$template\".leader.role" "$roles_file")
        local leader_instruction=$(jq -r ".templates.\"$template\".leader.instruction" "$roles_file")
        local manager_role=$(jq -r ".templates.\"$template\".manager.role" "$roles_file")
        local manager_instruction=$(jq -r ".templates.\"$template\".manager.instruction" "$roles_file")
        
        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        mkdir -p "instructions-built/teams/$template"
        
        # ãƒªãƒ¼ãƒ€ãƒ¼æŒ‡ç¤ºæ›¸ã®çµ±åˆ
        merge_instructions \
            "./instructions-src/base/leader.md" \
            "./instructions-src/templates/$leader_instruction" \
            "./instructions-built/teams/$template/${leader_role}.md" \
            "$leader_role" \
            "$manager_role" \
            "$(jq -r ".templates.\"$template\".workers[0].role" "$roles_file")"
        
        # ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æŒ‡ç¤ºæ›¸ã®çµ±åˆ
        merge_instructions \
            "./instructions-src/base/manager.md" \
            "./instructions-src/templates/$manager_instruction" \
            "./instructions-built/teams/$template/${manager_role}.md" \
            "$leader_role" \
            "$manager_role" \
            "$(jq -r ".templates.\"$template\".workers[0].role" "$roles_file")"
        
        # ãƒ¯ãƒ¼ã‚«ãƒ¼æŒ‡ç¤ºæ›¸ã®çµ±åˆ
        local worker_count=$(jq -r ".templates.\"$template\".workers | length" "$roles_file")
        for ((i=0; i<$worker_count; i++)); do
            local worker_role=$(jq -r ".templates.\"$template\".workers[$i].role" "$roles_file")
            local worker_instruction=$(jq -r ".templates.\"$template\".workers[$i].instruction" "$roles_file")
            
            merge_instructions \
                "./instructions-src/base/worker.md" \
                "./instructions-src/templates/$worker_instruction" \
                "./instructions-built/teams/$template/${worker_role}.md" \
                "$leader_role" \
                "$manager_role" \
                "$worker_role"
        done
        
        log_success "âœ… $template ($team_name) å®Œäº†"
    done
}

# æ±ç”¨å½¹å‰²æŒ‡ç¤ºæ›¸ã®ãƒ“ãƒ«ãƒ‰
build_generic_roles() {
    log_info "ğŸ­ æ±ç”¨å½¹å‰²æŒ‡ç¤ºæ›¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
    
    # æ±ç”¨ãƒªãƒ¼ãƒ€ãƒ¼
    if [ -f "./instructions-src/base/leader.md" ]; then
        cp "./instructions-src/base/leader.md" "./instructions-built/roles/leader.md"
        add_build_header "./instructions-built/roles/leader.md" "./instructions-src/base/leader.md" "ãªã—"
    fi
    
    # æ±ç”¨ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
    if [ -f "./instructions-src/base/manager.md" ]; then
        cp "./instructions-src/base/manager.md" "./instructions-built/roles/manager.md"
        add_build_header "./instructions-built/roles/manager.md" "./instructions-src/base/manager.md" "ãªã—"
    fi
    
    # æ±ç”¨ãƒ¯ãƒ¼ã‚«ãƒ¼
    if [ -f "./instructions-src/base/worker.md" ]; then
        cp "./instructions-src/base/worker.md" "./instructions-built/roles/worker.md"
        add_build_header "./instructions-built/roles/worker.md" "./instructions-src/base/worker.md" "ãªã—"
    fi
    
    log_success "âœ… æ±ç”¨å½¹å‰²æŒ‡ç¤ºæ›¸å®Œäº†"
}

# ãƒ“ãƒ«ãƒ‰çµ±è¨ˆã®è¡¨ç¤º
show_build_stats() {
    log_info "ğŸ“Š ãƒ“ãƒ«ãƒ‰çµ±è¨ˆ:"
    echo ""
    echo "ğŸ“ ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«:"
    echo "  teams/    $(find instructions-built/teams -name "*.md" | wc -l) ãƒ•ã‚¡ã‚¤ãƒ«"
    echo "  roles/    $(find instructions-built/roles -name "*.md" | wc -l) ãƒ•ã‚¡ã‚¤ãƒ«"
    echo ""
    echo "ğŸ“‹ ãƒãƒ¼ãƒ åˆ¥æŒ‡ç¤ºæ›¸:"
    for team_dir in instructions-built/teams/*/; do
        if [ -d "$team_dir" ]; then
            local team_name=$(basename "$team_dir")
            local file_count=$(find "$team_dir" -name "*.md" | wc -l)
            echo "  $team_name: $file_count ãƒ•ã‚¡ã‚¤ãƒ«"
        fi
    done
}

# ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ãƒ¢ãƒ¼ãƒ‰
watch_mode() {
    log_info "ğŸ‘€ ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ãƒ¢ãƒ¼ãƒ‰é–‹å§‹..."
    log_info "instructions-src/ ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ã„ã¾ã™..."
    log_info "Ctrl+C ã§çµ‚äº†"
    
    if command -v fswatch &> /dev/null; then
        fswatch -o instructions-src/ | while read f; do
            log_info "ğŸ”„ å¤‰æ›´æ¤œçŸ¥ - è‡ªå‹•ãƒ“ãƒ«ãƒ‰é–‹å§‹"
            build_all
        done
    elif command -v inotifywait &> /dev/null; then
        while inotifywait -r -e modify,create,delete instructions-src/; do
            log_info "ğŸ”„ å¤‰æ›´æ¤œçŸ¥ - è‡ªå‹•ãƒ“ãƒ«ãƒ‰é–‹å§‹"
            build_all
        done
    else
        log_error "ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ãƒ„ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        log_info "Mac: brew install fswatch"
        log_info "Linux: sudo apt-get install inotify-tools"
        exit 1
    fi
}

# å…¨ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
build_all() {
    local start_time=$(date +%s)
    
    log_info "ğŸ—ï¸ æŒ‡ç¤ºæ›¸ãƒ“ãƒ«ãƒ‰é–‹å§‹..."
    echo ""
    
    # ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
    mkdir -p instructions-built/{teams,roles}
    
    # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
    build_role_instructions
    echo ""
    build_generic_roles
    echo ""
    
    # çµ±è¨ˆè¡¨ç¤º
    show_build_stats
    
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    echo ""
    log_success "ğŸ‰ ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼ (${duration}ç§’)"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    echo "ğŸ—ï¸ Instructions Build System"
    echo "============================="
    echo ""
    
    # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    check_dependencies
    
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‡¦ç†
    case "${1:-}" in
        "--clean")
            clean_build
            ;;
        "--watch")
            build_all
            echo ""
            watch_mode
            ;;
        "--help")
            usage
            ;;
        "")
            build_all
            ;;
        *)
            log_error "ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
            usage
            ;;
    esac
}

main "$@" 